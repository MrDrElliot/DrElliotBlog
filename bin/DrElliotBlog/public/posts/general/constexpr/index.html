<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Constexpr and Consteval | Dr. Elliot</title>
<link rel="icon" href="/favicon.svg" sizes="any" type="image/svg+xml" /><meta property="og:url" content="https://www.dr-elliot.com/posts/general/constexpr/">
  <meta property="og:site_name" content="Dr. Elliot">
  <meta property="og:title" content="Constexpr and Consteval">
  <meta property="og:description" content="Simple way to possibly increase some performance. This blog is a follow-up to this YouTube video: https://www.youtube.com/watch?v=8-VZoXn8f9U
Consider the following code:
// ConstexprExample.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there. // #include &lt;iostream&gt; #include &lt;chrono&gt; int Fibonacci(int n) { if (n &lt;= 1) return n; return Fibonacci(n - 1) &#43; Fibonacci(n - 2); } constexpr int Fibonacci_C(int n) { if (n &lt;= 1) return n; return Fibonacci_C(n - 1) &#43; Fibonacci_C(n - 2); } int main() { auto Start = std::chrono::high_resolution_clock::now(); constexpr int num = 25; constexpr int result_c = Fibonacci_C(num); std::cout &lt;&lt; &#34;Constexpr Fibonacci: &#34; &lt;&lt; result_c &lt;&lt; &#39;\n&#39;; std::cout &lt;&lt; &#34;Time Taken: &#34; &lt;&lt; std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(std::chrono::high_resolution_clock::now() - Start).">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-08-16T13:46:48-05:00">
    <meta property="article:modified_time" content="2024-08-16T13:46:48-05:00">
    <meta property="article:tag" content="C&#43;&#43;">
    <meta property="article:tag" content="CPP">
    <meta property="article:tag" content="Optimization">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Constexpr and Consteval">
  <meta name="twitter:description" content="Simple way to possibly increase some performance. This blog is a follow-up to this YouTube video: https://www.youtube.com/watch?v=8-VZoXn8f9U
Consider the following code:
// ConstexprExample.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there. // #include &lt;iostream&gt; #include &lt;chrono&gt; int Fibonacci(int n) { if (n &lt;= 1) return n; return Fibonacci(n - 1) &#43; Fibonacci(n - 2); } constexpr int Fibonacci_C(int n) { if (n &lt;= 1) return n; return Fibonacci_C(n - 1) &#43; Fibonacci_C(n - 2); } int main() { auto Start = std::chrono::high_resolution_clock::now(); constexpr int num = 25; constexpr int result_c = Fibonacci_C(num); std::cout &lt;&lt; &#34;Constexpr Fibonacci: &#34; &lt;&lt; result_c &lt;&lt; &#39;\n&#39;; std::cout &lt;&lt; &#34;Time Taken: &#34; &lt;&lt; std::chrono::duration_cast&lt;std::chrono::microseconds&gt;(std::chrono::high_resolution_clock::now() - Start).">

      <link rel="stylesheet" href="/css/root.min.0e732b812b9751962e01a7c4798a1211cd5f8ac8abec7f99793fe306989e459f.css" integrity="sha256-DnMrgSuXUZYuAafEeYoSEc1fisir7H&#43;ZeT/jBpieRZ8=" crossorigin="anonymous">
      <link rel="stylesheet" href="/css/bundle.min.59eb1a059f8cd558e64375ede3e68d3e9120ddb0c6bdbab555c247689cef59e1.css" integrity="sha256-WesaBZ&#43;M1VjmQ3Xt4&#43;aNPpEg3bDGvbq1VcJHaJzvWeE=" crossorigin="anonymous">

      <script src="/js/bundle.cc8ae9952dbfb731affafabdf26e5c60a6910047ff59ccdeaf1daebaa26c8830.js" integrity="sha256-zIrplS2/tzGv&#43;vq98m5cYKaRAEf/Wczerx2uuqJsiDA=" crossorigin="anonymous"></script><script defer src="/js/search/flexsearch.compact.5e0de3b335e5c523c7cf45473dc43fccb6c75f64a9d59cc04a6eccbb7c25eb49.js" integrity="sha256-Xg3jszXlxSPHz0VHPcQ/zLbHX2Sp1ZzASm7Mu3wl60k="></script>
<script defer src="/js/search/search.1d980f84df11f3eb7c8c5f17f541d49a0611608df179dd74fa7f06225eb56ace.js" integrity="sha256-HZgPhN8R8&#43;t8jF8X9UHUmgYRYI3xed10&#43;n8GIl61as4="></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&family=Spectral:ital,wght@0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap" rel="stylesheet">

</head>
<body class="notransition">
  <div id="container">
    <header id="main-header"><div role="navigation" aria-label="Main">
  <div class="nav-left">
    <a href="https://www.dr-elliot.com/" style="color: inherit;">Dr. Elliot</a>
  </div>
  <div class="nav-right">
    <div style="position:absolute;width:0px;height:0px;">
      <div id="nav-dropdown-menu" class="hidden" href="#">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/lumina/lumina/"
      >Lumina</a>
    </div>
    <div class="nav-item">
      <a href="/about/aboutme/"
      >About</a>
    </div>
</div>
    </div>
    <a id="nav-dropdown-button" href="#"><svg width="20px" height="20px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6H20M4 12H20M4 18H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
    <div id="nav-menu">
    <div class="nav-item">
      <a aria-current="true" class="ancestor" href="/posts/"
      >Posts</a>
    </div>
    <div class="nav-item">
      <a href="/lumina/lumina/"
      >Lumina</a>
    </div>
    <div class="nav-item">
      <a href="/about/aboutme/"
      >About</a>
    </div>
</div>
    <a id="theme-switcher" href="#">
<svg class="light-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M12 3V4M12 20V21M4 12H3M6.31412 6.31412L5.5 5.5M17.6859 6.31412L18.5 5.5M6.31412 17.69L5.5 18.5001M17.6859 17.69L18.5 18.5001M21 12H20M16 12C16 14.2091 14.2091 16 12 16C9.79086 16 8 14.2091 8 12C8 9.79086 9.79086 8 12 8C14.2091 8 16 9.79086 16 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>

<svg class="dark-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M3.32031 11.6835C3.32031 16.6541 7.34975 20.6835 12.3203 20.6835C16.1075 20.6835 19.3483 18.3443 20.6768 15.032C19.6402 15.4486 18.5059 15.6834 17.3203 15.6834C12.3497 15.6834 8.32031 11.654 8.32031 6.68342C8.32031 5.50338 8.55165 4.36259 8.96453 3.32996C5.65605 4.66028 3.32031 7.89912 3.32031 11.6835Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
</a>
  </div>
</div>
</header>
    <div class="flex grow">
      <div id="main-pane">
        <main id="main-content"><div class="single-header">
<ol class="breadcrumbs" itemscope itemtype="https://schema.org/BreadcrumbList">
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="https://www.dr-elliot.com/">
        <span itemprop="name">Home</span>
      </a>
      <meta itemprop="position" content='1' />
    </li>
    <span>&nbsp»&nbsp</span>
    <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
      <a itemprop="item" href="https://www.dr-elliot.com/posts/">
        <span itemprop="name">Posts</span>
      </a>
      <meta itemprop="position" content='2' />
    </li>
    <span>&nbsp»&nbsp</span>
</ol>
<h1>Constexpr and Consteval</h1><time class="dim" datetime="2024-08-16T13:46:48-05:00">August 16, 2024</time><div class="term-container"><div class="tag">
        <a href="https://www.dr-elliot.com/tags/c&#43;&#43;/">#C&#43;&#43;</a>
      </div><div class="tag">
        <a href="https://www.dr-elliot.com/tags/cpp/">#CPP</a>
      </div><div class="tag">
        <a href="https://www.dr-elliot.com/tags/optimization/">#Optimization</a>
      </div></ol></div>

  <section class="page-section"><h1 id="simple-way-to-possibly-increase-some-performance">Simple way to possibly increase some performance.</h1>
<p>This blog is a follow-up to this YouTube video: <a href="https://www.youtube.com/watch?v=8-VZoXn8f9U">https://www.youtube.com/watch?v=8-VZoXn8f9U</a></p>
<p>Consider the following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ConstexprExample.cpp : This file contains the &#39;main&#39; function. Program execution begins and ends there.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;chrono&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Fibonacci</span>(<span style="color:#66d9ef">int</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Fibonacci(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> Fibonacci(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Fibonacci_C</span>(<span style="color:#66d9ef">int</span> n)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">return</span> n;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> Fibonacci_C(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> Fibonacci_C(n <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> Start <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>high_resolution_clock<span style="color:#f92672">::</span>now();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">constexpr</span> <span style="color:#66d9ef">int</span> result_c <span style="color:#f92672">=</span> Fibonacci_C(num);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Constexpr Fibonacci: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> result_c <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Time Taken: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>duration_cast<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>microseconds<span style="color:#f92672">&gt;</span>(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>high_resolution_clock<span style="color:#f92672">::</span>now() <span style="color:#f92672">-</span> Start).count() <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Start <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>high_resolution_clock<span style="color:#f92672">::</span>now();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> Fibonacci(num);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Normal Fibonacci: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> result <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#39;\n&#39;</span>;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Time Taken: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>duration_cast<span style="color:#f92672">&lt;</span>std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>microseconds<span style="color:#f92672">&gt;</span>(std<span style="color:#f92672">::</span>chrono<span style="color:#f92672">::</span>high_resolution_clock<span style="color:#f92672">::</span>now() <span style="color:#f92672">-</span> Start).count();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="performance-differences">Performance Differences</h2>
<p>Here we see we are evaluating a classic Fibonacci recursive function. Recursion like this can be incredibly expensive. On the order of O(2^n).</p>
<p>When comparing the two versions of the Fibonacci function—one using a normal recursive function (<code>Fibonacci</code>) and the other using <code>constexpr</code> (<code>Fibonacci_C</code>)—we can observe significant performance differences, especially as the input size increases.</p>
<h3 id="fibonacci-normal-function"><code>Fibonacci</code> (Normal Function)</h3>
<p>The <code>Fibonacci</code> function is evaluated at runtime. Every time the program is executed, the function goes through the recursive calls to compute the result, which can be quite costly. For example, with <code>n = 25</code>, the function performs thousands of recursive calls, resulting in significant computational overhead. As the input grows, the execution time increases exponentially, which is evident from the output when you measure the time taken for the function to compute the result.</p>
<h3 id="fibonacci_c-constexpr-function"><code>Fibonacci_C</code> (Constexpr Function)</h3>
<p>On the other hand, the <code>Fibonacci_C</code> function is a <code>constexpr</code> function. If the input is known at compile time (as in this case, with <code>num = 25</code>), the compiler can evaluate the function during compilation. This means the result is computed once, and the precomputed value is embedded directly into the binary, leading to a drastic reduction in runtime computation. The time measured in this scenario is almost negligible because the function itself isn&rsquo;t actually being executed at runtime—the value is already there.</p>
<h3 id="output-comparison">Output Comparison</h3>
<p>The difference in time taken for the two approaches might look something like this:</p>
<pre tabindex="0"><code>Constexpr Fibonacci: 75025
Time Taken: 211 microseconds
Normal Fibonacci: 75025   
Time Taken: 620 microseconds
</code></pre><p>These numbers will grow exponentially the larger the input number (number of recursive functions) is.</p>
<p>In this hypothetical output, we see that the <code>constexpr</code> version takes effectively no time at runtime because the work was done at compile time, whereas the normal function takes a considerable amount of time due to the nature of recursion.</p>
<h2 id="constexpr-vs-consteval"><code>constexpr</code> vs. <code>consteval</code></h2>
<h3 id="constexpr"><code>constexpr</code></h3>
<ul>
<li><strong>Definition</strong>: <code>constexpr</code> is a keyword introduced in C++11 that suggests to the compiler that the function can be evaluated at compile time. However, if the inputs are not known at compile time, the function will be executed at runtime.</li>
<li><strong>Usage</strong>: Use <code>constexpr</code> when you want a function to be evaluated at compile time if possible, but you&rsquo;re okay with it being evaluated at runtime if necessary.</li>
<li><strong>Pros</strong>:
<ul>
<li>Flexibility: It allows both compile-time and runtime evaluation.</li>
<li>Performance: If evaluated at compile time, it can reduce runtime overhead.</li>
</ul>
</li>
<li><strong>Cons</strong>:
<ul>
<li>Uncertainty: There’s no guarantee that the function will always be evaluated at compile time, depending on the context in which it is used.</li>
</ul>
</li>
</ul>
<h3 id="consteval"><code>consteval</code></h3>
<ul>
<li><strong>Definition</strong>: <code>consteval</code>, introduced in C++20, forces a function to be evaluated at compile time. If you try to call a <code>consteval</code> function with inputs that are not known at compile time, the code will not compile.</li>
<li><strong>Usage</strong>: Use <code>consteval</code> when you want to ensure that a function is always evaluated at compile time, without exception.</li>
<li><strong>Pros</strong>:
<ul>
<li>Guarantees: You can be certain that the function is never evaluated at runtime, which can be crucial for certain performance-critical or safety-critical applications.</li>
</ul>
</li>
<li><strong>Cons</strong>:
<ul>
<li>Rigidity: You lose the flexibility of runtime evaluation. If the inputs aren&rsquo;t known at compile time, you can&rsquo;t use a <code>consteval</code> function.</li>
</ul>
</li>
</ul>
<h2 id="when-to-use-constexpr-vs-consteval">When to Use <code>constexpr</code> vs. <code>consteval</code></h2>
<h3 id="when-to-use-constexpr">When to Use <code>constexpr</code>:</h3>
<ul>
<li>When you have functions that could benefit from compile-time evaluation but may also need to support runtime evaluation depending on the context.</li>
<li>For code that is part of a library where flexibility is important—allowing the user to decide if they want compile-time or runtime evaluation.</li>
</ul>
<h3 id="when-to-use-consteval">When to Use <code>consteval</code>:</h3>
<ul>
<li>When you require the result to be known at compile time, such as in the case of template metaprogramming or when defining constants that must be computed at compile time.</li>
<li>For performance-critical code where runtime computation would be prohibitively expensive, and you want to guarantee compile-time computation.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>Understanding the differences between <code>constexpr</code> and <code>consteval</code> can significantly influence the performance of your code. <code>constexpr</code> offers flexibility but leaves the decision to the compiler, while <code>consteval</code> provides certainty at the cost of flexibility. Depending on the specific needs of your application—whether you prioritize performance, compile-time guarantees, or runtime flexibility—choosing the right tool for the job can lead to more efficient and maintainable code.</p>
<p>As always, profile your code and consider the specific context in which you&rsquo;re working to make the best decision.</p>
</section>

  <section id="comments">
    <script src="https://utteranc.es/client.js"
        repo="MrDrElliot/DrElliotBlog"
        issue-term="pathname"
        theme="github-dark"
        crossorigin="anonymous"
        async>
    </script>
</section>
</main>
        <footer id="main-footer"><div class="footer">
  <a href="#">Scroll to Top</a>
  <div class="footer-copyright">
    <div class="dim">© 2025 Dr. Elliot</div>
    <div>Made with ❤️ and powered by <a href="https://github.com/math-queiroz/rusty-typewriter" target="_blank">Rusty Typewriter</a> theme for <a href="https://gohugo.io/" target="_blank">Hugo</a></div>
  </div>
</div>
</footer>
      </div><aside id="side-pane" class="side-sticky"><div class="side-details">
    <span>856 words</span>
    <span>5 - 7 minutes read</span></div><h3>Table Of Contents</h3><nav id="TableOfContents">
  <ul>
    <li><a href="#performance-differences">Performance Differences</a>
      <ul>
        <li><a href="#fibonacci-normal-function"><code>Fibonacci</code> (Normal Function)</a></li>
        <li><a href="#fibonacci_c-constexpr-function"><code>Fibonacci_C</code> (Constexpr Function)</a></li>
        <li><a href="#output-comparison">Output Comparison</a></li>
      </ul>
    </li>
    <li><a href="#constexpr-vs-consteval"><code>constexpr</code> vs. <code>consteval</code></a>
      <ul>
        <li><a href="#constexpr"><code>constexpr</code></a></li>
        <li><a href="#consteval"><code>consteval</code></a></li>
      </ul>
    </li>
    <li><a href="#when-to-use-constexpr-vs-consteval">When to Use <code>constexpr</code> vs. <code>consteval</code></a>
      <ul>
        <li><a href="#when-to-use-constexpr">When to Use <code>constexpr</code>:</a></li>
        <li><a href="#when-to-use-consteval">When to Use <code>consteval</code>:</a></li>
      </ul>
    </li>
    <li><a href="#conclusion">Conclusion</a></li>
  </ul>
</nav><h3>Related</h3>
    <ul><li><a href="/posts/memory/buffers/">Working With Buffers</a></li></ul></aside></div>
  </div>
</body>
</html>
